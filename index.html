<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Práctica VAN - 2º Bachillerato</title>
<style>
body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; }
input { margin: 5px; width: 100px; }
.hidden { display: none; }
h1, h3 { color: #2c3e50; }
button { padding: 5px 10px; margin-top: 10px; }
table { border-collapse: collapse; margin-top: 10px; }
td, th { border: 1px solid #ccc; padding: 5px 10px; }
</style>
</head>
<body>
<h1>Práctica de VAN - 2º Bachillerato</h1>

<div id="inicio">
    <label>Nombre del alumno: <input type="text" id="nombre"></label><br><br>
    <label>Nivel de dificultad:
        <select id="nivel">
            <option value="3">Básico (3 años)</option>
            <option value="6">Medio (6 años)</option>
            <option value="10">Difícil (10 años)</option>
        </select>
    </label><br><br>
    <button onclick="generarProyecto()">Generar Proyecto</button>
</div>

<div id="proyecto" class="hidden">
    <h3>Datos del proyecto</h3>
    <p>Inversión inicial: <span id="inversion"></span></p>
    <p>Tasa de descuento: <span id="tasa"></span>%</p>

    <table id="tablaFlujos">
        <tr><th>Año</th><th>Ingreso</th><th>Gasto</th></tr>
    </table>

    <label>Introduce tu cálculo del VAN: <input type="number" id="vanAlumno"></label><br>
    <button onclick="verificarVAN()">Verificar VAN</button>
</div>

<div id="resultado" class="hidden"></div>

<script>
// Generar número aleatorio entero
function aleatorio(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

let vanCorrecto = 0;

function generarProyecto() {
    const nombre = document.getElementById("nombre").value.trim();
    if (!nombre) { alert("Introduce tu nombre"); return; }

    const nivel = parseInt(document.getElementById("nivel").value);
    const inversion = aleatorio(5000, 20000);
    const tasa = aleatorio(5, 15); // %
    document.getElementById("inversion").innerText = inversion;
    document.getElementById("tasa").innerText = tasa;

    const tabla = document.getElementById("tablaFlujos");
    // Limpiar filas anteriores
    while (tabla.rows.length > 1) tabla.deleteRow(1);

    // Generar flujos aleatorios
    let flujos = [];
    for (let i = 1; i <= nivel; i++) {
        const ingreso = aleatorio(2000, 10000);
        const gasto = aleatorio(0, 5000);
        flujos.push(ingreso - gasto);
        const row = tabla.insertRow();
        row.insertCell(0).innerText = i;
        row.insertCell(1).innerText = ingreso;
        row.insertCell(2).innerText = gasto;
    }

    // Calcular VAN correcto
    vanCorrecto = -inversion;
    for (let i = 0; i < flujos.length; i++) {
        vanCorrecto += flujos[i] / Math.pow(1 + tasa/100, i+1);
    }

    localStorage.setItem("nombreActual", nombre);
    document.getElementById("inicio").classList.add("hidden");
    document.getElementById("proyecto").classList.remove("hidden");
}

// Verificar VAN ingresado por alumno
function verificarVAN() {
    const nombre = localStorage.getItem("nombreActual");
    const vanAlumno = parseFloat(document.getElementById("vanAlumno").value);
    if (isNaN(vanAlumno)) { alert("Introduce un número válido"); return; }

    // Comparar con VAN correcto dentro de un margen (5%)
    const margen = Math.abs(vanCorrecto) * 0.05; 
    let nota;
    if (Math.abs(vanAlumno - vanCorrecto) <= margen) nota = 10;
    else if (Math.abs(vanAlumno - vanCorrecto) <= margen*2) nota = 8;
    else if (Math.abs(vanAlumno - vanCorrecto) <= margen*4) nota = 6;
    else if (Math.abs(vanAlumno - vanCorrecto) <= margen*6) nota = 4;
    else nota = 2;

    // Guardar historial
    let historial = JSON.parse(localStorage.getItem("historialVAN") || "{}");
    if (!historial[nombre]) historial[nombre] = { intentos:0, aciertos:0 };
    historial[nombre].intentos += 1;
    if (nota >= 6) historial[nombre].aciertos += 1;
    localStorage.setItem("historialVAN", JSON.stringify(historial));
    const porcentaje = (historial[nombre].aciertos / historial[nombre].intentos) * 100;

    // Mostrar resultado
    const resDiv = document.getElementById("resultado");
    resDiv.innerHTML = `
        <h3>Resultado del alumno ${nombre}</h3>
        VAN correcto: ${vanCorrecto.toFixed(2)}<br>
        Tu VAN: ${vanAlumno.toFixed(2)}<br>
        Nota obtenida: ${nota}/10<br>
        Porcentaje de aciertos histórico: ${porcentaje.toFixed(2)}%<br><br>
        <button onclick="reiniciar()">Nuevo proyecto</button>
    `;
    resDiv.classList.remove("hidden");
}

function reiniciar() {
    document.getElementById("inicio").classList.remove("hidden");
    document.getElementById("proyecto").classList.add("hidden");
    document.getElementById("resultado").classList.add("hidden");
    document.getElementById("vanAlumno").value = "";
}
</script>
</body>
</html>
